"use strict";const he=require("he"),whitespace=/[\x20\t\r\n\f]/;module.exports={clean:htmlClean,escape:e=>he.escape(e),encode:e=>he.encode(e),unescape:e=>he.decode(e),decode:e=>he.decode(e),get voidTags(){return VOID_TAGS},get blackList(){return BLACKLIST},get whiteAttributes(){return WHITE_ATTRIBUTES},get whiteStyle(){return WHITE_STYLES}};const scriptStyleTags=["script","style"];function HTMLSeeker(e,t,s){for(var a,i,r,n,l=e.length,o=!1,c=!1,g=!1,h=0,T=!1,d=0;d<l;++d)a=e.charAt(d),!1!==c?"<"===a?T=d:">"===a&&!1!==T&&e.substring(T,d).toLowerCase().startsWith("</"+c)&&(t(r,n,i,e.substring(h,T)),T=!1,c=!1,h=d+1,o=!1):!1===o?"<"===a&&(s(e.substring(h,d)),o=d,h=d):!1!==g?"\\"===a?++d:g===a&&(g=!1):'"'===a||"'"===a?g=a:">"===a&&((r=(i=e.substring(h,d+1)).match(/^<([\/!]?[\w-]*)/))?(n=(r=r[1]).toLowerCase(),-1!==scriptStyleTags.indexOf(n)?((c=n).length+1,h):t(r,n,i)):t(r=void 0,n=void 0,i),h=d+1,o=!1);h<l&&s(e.substring(h))}function htmlAttrSeeker(e,t){var s,a=0,i=!1,r=!1,n=0,l=[],o=()=>{4===n?(t(r,he.decode(e.substring(a,g))),r=!1,n=0):2===n?(t(r,!0),r=!1,n=0):1===n&&(r=e.substring(a,g).toLowerCase(),n=2)};if(g=e.match(/\s/)){for(var c=e.length,g=g.index+1;g<c;++g)"\\"==(s=e.charAt(g))?++g:!1!==i?i===s&&(i=!1,o()):'"'===s||"'"===s?(i=s,a=g+1,++n):"="===s?0===n?l.push('incurrect "=" at col:'+g):1===n?(o(),n=3):2===n&&(n=3):whitespace.test(s)||">"===s||"/"===s?o():1===n||4===n||(a=g,2===n&&o(),n=3===n?4:1);!1!==r&&o()}return l}const VOID_TAGS="img,br,hr,input,area,col,command,embed,keygen,link,meta,param,source,track,wbr,base,circle,path".split(","),BLACKLIST="title,script,input,link,meta,base,style,frame,noscript,canvas".split(","),RM_TAG_ONLY="html,head,body,!doctype,iframe".split(","),WHITE_ATTRIBUTES={"*":["style"],img:["style","src","srcset","width","height"],a:["style","href","hreflang","target","download"],font:["style","color","face","size"]},WHITE_STYLES={"*":/^(?:background|border|box|break|clear|color|display|font|height|letter|lighting|list-style|margin|max-height|max-width|min-height|min-width|padding|text|width|word)/i},lowLevelTags="a,b,u,i,var,font,abbr,address,bdi,br,canvas,caption,center,cite,code,em,hr,label,legend,mark,strong,sub,sup,".split(","),ACCEPT_TAGS="svg".split(","),JS_ATTR_CHECK=/\bjavascript\s*\:/i,REMOVE_TAG_SYMB=Symbol(),STYLE_ATTR_SYMB=Symbol(),OPTIONS_SYMB=Symbol(),DEFAULT_OPTIONS={comments:!1,img:!0},TAG_HELPER={get attributes(){var e={};return Object.defineProperty(e,"style",{get:initStyle,configurable:!0,enumerable:!0}),htmlAttrSeeker(this.body,(t,s)=>{"style"===t?e[STYLE_ATTR_SYMB]=s:e[t]=s}),Object.defineProperty(this,"attributes",{value:e,writable:!0,enumerable:!0}),e},clean:function(){var e=this.attributes;if(this.svg)Object.keys(e).forEach(t=>{e[t]&&!JS_ATTR_CHECK.test(e[t])||delete e[t]});else{var t=this[OPTIONS_SYMB].acceptedAttr||WHITE_ATTRIBUTES;t=t[this.tagName]||t["*"],Object.keys(e).forEach(s=>{-1!==t.indexOf(s)?"style"===s?this.cleanStyle():JS_ATTR_CHECK.test(e[s])&&delete e[s]:delete e[s]}),0===Object.keys(e).length&&-1===lowLevelTags.indexOf(this.tagName)&&(this[REMOVE_TAG_SYMB]=!0)}},cleanStyle:cleanStyle,get html(){var e,t,s=this.attributes,a=Object.keys(s),i=this.body.endsWith("/>")?" />":">";return 0===a.length?t=this.svg||-1!==lowLevelTags.indexOf(this.tagName)?"<"+this.tagName+i:"":(t="",a.forEach(a=>{"style"===a?""!==(e=_joinStyle(s.style))&&(t+=' style="'+he.escape(e)+'"'):s[a]&&(t+=" "+he.escape(a)+'="'+he.escape(s[a]+"")+'"')}),""!==t?t="<"+this.tagName+t+i:(this.svg||-1!==lowLevelTags.indexOf(this.tagName))&&(t="<"+this.tagName+i)),t}};function _joinStyle(e){var t=[];for(var s in e)t.push(s+":"+e[s]);return t.join(";")}function htmlClean(e,t){var s,a,i,r,n,l=[],o="",c=[];t||(t=DEFAULT_OPTIONS),!0!==t.comments&&(e=e.replace(/<!--[\s\S]*?-->/g,""));var g=!1;if(HTMLSeeker(e,(e,h,T,d)=>{if(s=e.startsWith("/")){for(h=h.substr(1);;){if(!(i=l.pop())||i.tagName===h)break;if(c.push({tag:h,msg:"incorrect closing tag"}),-1!==lowLevelTags.indexOf(h)&&-1===lowLevelTags.indexOf(i.tagName)){l.push(i),i=null;break}!1===g?!0!==i[REMOVE_TAG_SYMB]&&(-1===lowLevelTags.indexOf(i.tagName)?-1===lowLevelTags.indexOf(h)?o+="</"+i.tagName+">":c.push({tag:h,msg:"closing tag removed"}):(o+="</"+i.tagName+">",c.push({tag:i.tagName,msg:"inclosed tag"}))):i===g&&(g=!1)}i&&(i===g?g=!1:!0===i[REMOVE_TAG_SYMB]||(o+="</"+i.tagName+">"))}else{if(a=!s&&(-1!=VOID_TAGS.indexOf(h)||T.endsWith("/>")),r=-1!=BLACKLIST.indexOf(h),i={[OPTIONS_SYMB]:t},l.length>0&&Object.defineProperty(i,"parentNode",{value:l[l.length-1],enumerable:!0}),("svg"===h||i.parentNode&&!0===i.parentNode.svg)&&(i.svg=!0),Object.defineProperties(i,{tagName:{value:h},tagNameOrigine:{value:e},body:{value:T},isVoidTag:{value:a},isBlackList:{value:r}}),d&&Object.defineProperty(i,"content",{value:d,enumerable:!0}),Object.setPrototypeOf(i,TAG_HELPER),!1===g)if(!0===(n=t.onTag&&t.onTag(i)))response+=i.html;else if(!1===n)i[REMOVE_TAG_SYMB]=!0;else if("string"==typeof n)response+=n,!0!==i.isVoidTag&&(g=i);else{if(void 0!==n)throw new Error("uncorrect cb response");"img"===h?!0===t.img&&(i.clean(),o+=i.html):r?!0!==i.isVoidTag&&(g=i):-1!==RM_TAG_ONLY.indexOf(h)?i[REMOVE_TAG_SYMB]=!0:(i.clean(),""===(n=i.html)?i[REMOVE_TAG_SYMB]=!0:o+=n)}!1===a&&(!1!==g&&(i[REMOVE_TAG_SYMB]=!0),l.push(i))}},e=>{!1===g&&(!0!==t.keepBlanks&&(e=e.replace(/\s{2,}/g,"\n").trim()),""!==e&&(o+=" "+e))}),!1===g)for(;;){if(!(i=l.pop()))break;!0!==i[REMOVE_TAG_SYMB]&&(c.push({tag:i.tagName,msg:"not closed tag, closing it"}),o+="</"+i.tagName+">")}return o}function initStyle(){var e={},t=this[STYLE_ATTR_SYMB];return t&&styleParser(t=t.replace(/\/\*[\s\S]*?\*\//,""),(t,s)=>e[t]=s),Object.defineProperty(this,"style",{value:e,configurable:!0,enumerable:!0}),e}function styleParser(e,t){for(var s,a=!1,i=!1,r=0,n=()=>{!1!==i&&(t(i,e.substring(r,o).trim()),i=!1)},l=e.length,o=0;o<l;++o)"\\"===(s=e.charAt(o))?++o:!1!==a?s===a&&(a=!1):":"===s?(i=e.substring(r,o).trim(),r=o+1):";"===s?(n(),r=o+1):'"'!==s&&"'"!==s||(a=s);n()}const CSS_JS_REGEX=/javascript\s*:|^expression/i;function cleanStyle(){var e=this.attributes.style,t=this[OPTIONS_SYMB].acceptedStyle||WHITE_STYLES;for(var s in t=t[this.tagName]||t["*"],e)t.test(s)&&!CSS_JS_REGEX.test(e[s])||delete e[s]}